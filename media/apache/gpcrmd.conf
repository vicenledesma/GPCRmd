LoadModule wsgi_module "/opt/gpcrmdenv/lib/python3.9/site-packages/mod_wsgi/server/mod_wsgi-py39.cpython-39-x86_64-linux-gnu.so"
WSGIPythonHome "/opt/gpcrmdenv"
WSGIRestrictStdout Off
LogLevel info
<VirtualHost *:80>
    AddCharset UTF-8 .log
    AddType text/plain; .log
    
    #Uncomment for Apache mod_proxy method
    ProxyRequests Off
    <Proxy *>
        Require all granted
    </Proxy>
    ProxyPass /mdsrv_redirect/ http://localhost:8081/mdsrv/
    ProxyPassReverse /mdsrv_redirect/ http://localhost:8081/mdsrv/
    ProxyPass /html/ http://localhost:8081/html/
    ProxyPassReverse /html/ http://localhost:8081/html/
    
    # Turn on for overriding WSGIApplication reverse proxy in POST requests and
    # for WSGI internal redirect + mod_proxy method.
    RewriteEngine On
    
    # WSGI internal redirect + mod_proxy method for reverse proxy GET request access restrictions.
    # Comment if not needed.
    RewriteCond %{THE_REQUEST} ^[\S]+\ /mdsrv_redirect/
    RewriteRule  "^/mdsrv_redirect/" - [F,L,NS]
    
    #Uncomment for overriding WSGIApplication reverse proxy for non-restricted files
    RewriteCond %{REQUEST_METHOD} POST
    RewriteRule "^/mdsrv/(.*/_DB/[^/\\]+)(/[^/\\]+)?$" "/mdsrv_redirect/$1$2" [QSA,L,PT]

    WSGIApplicationGroup %{GLOBAL}
    WSGIDaemonProcess gpcrmd python-path=/opt/gpcrmdenv/lib/python3.9
    WSGIProcessGroup www-data 
    WSGIApplicationGroup %{GLOBAL}

    Alias /static/ /var/www/GPCRmd/static
    #Alias /dynadb/files/ /protwis/sites/files/
    #Alias /media/ /protwis/media/protwis/
   
    #Serve only non-restricted files and allow WSGIApplication to handle restricted ones. 
    AliasMatch "^/dynadb/files/([^/\\\]+)(/[^/\\\]+)?$" "/protwis/sites/files/$1$2"
    WSGIScriptAlias / /protwis/sites/protwis/protwis/wsgi.py

    #Allow downloading static files (e.g. HTML, CSS, JS ...)
    <Directory /var/www/GPCRmd/static>
        AllowOverride None
        Require all granted
    </Directory>

    #Future possible location for media files
    <Directory /var/www/GPCRmd/media>
        AllowOverride None
        Require all granted
    </Directory>

    # Override files access restrictions for XSendFile
    XSendFilePath /var/www/GPCRmd/media/files/
    
    #Deny access to restricted media files
    <Directory /var/www/GPCRmd/media/files/*/*/*>
        AllowOverride None
        Require all denied
    </Directory>

    #Allow access to all uploaded and DB media files
    <Directory /var/www/GPCRmd/media/files>
        AllowOverride None
        Require all granted
    </Directory>

    #Allow access to WSGI application 
    <Directory "/var/www/GPCRmd/config">
        AllowOverride None
        Require all denied
        <Files "wsgi.py">
            #Listen for the XSendFile headers produced by this script
            XSendFile On
            #Order Deny,Allow
            #Allow from all
            Require all granted
        </Files>
    </Directory>
    <Directory "/usr/share/phpMyAdmin">
        Order allow,deny
        Allow from all 
    </Directory>


</VirtualHost>

# mdsrv app
<VirtualHost *:8081>
    KeepAlive On
    MaxKeepAliveRequests 100
    KeepAliveTimeout 5
    #DeflateCompressionLevel 5

    DocumentRoot /var/www/html
    
    # the wsgi process will run with the user & group specified below,
    # so make sure that the files and directories you want to serve
    # are accessible with that user & group combination
    WSGIDaemonProcess mdsrv user=www-data group=www-data python-home=/opt/gpcrmdenv
    WSGIScriptAlias /mdsrv /var/www/mdsrv/mdsrv.wsgi 
    <Directory /var/www/mdsrv>
        AllowOverride None
        #Order Deny,Allow
        #Deny from all
        Require all denied
        <Files mdsrv.wsgi>
        WSGIProcessGroup mdsrv
        WSGIApplicationGroup %{GLOBAL}
        WSGIScriptReloading On
        WSGIPassAuthorization On
        #Order Deny,Allow
        #Allow from all
        Require all granted
        </Files>
    </Directory>

    Alias /html/mdsrv/webapp/ /opt/gpcrmdenv/lib/python3.9/site-packages/mdsrv/webapp/
    Alias /mdsrv/webapp/ /opt/gpcrmdenv/lib/python3.9/site-packages/mdsrv/webapp/
    <Directory /opt/gpcrmdenv/lib/python3.9/site-packages/mdsrv/webapp/>
            SetOutputFilter DEFLATE
            AllowOverride None
            #Order Allow,Deny
            #Allow from all
            Require all granted
    </Directory>


    Alias /html/ /var/www/html/
    <Directory /var/www/html>
        SetOutputFilter DEFLATE
        Options FollowSymLinks
        AllowOverride None
        #Order Deny,Allow
        #Allow from all
        Require all granted
    </Directory>

    Alias /files/ /var/www/GPCRmd/media/files/
    #Allow acces to files to be displayed on mdsrv
    <Directory /var/www/GPCRmd/media/files>
        AllowOverride None
        Require all granted
    </Directory>

</VirtualHost>
